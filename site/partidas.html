<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nimue | Partidas publicadas</title>
    <style>
      :root {
        --bg: #0a0d1f;
        --text: #f7f8ff;
        --muted: #b5bbdc;
        --primary: #7c5cff;
        --card: rgba(255, 255, 255, 0.08);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        color: var(--text);
        background: radial-gradient(circle at 20% 0%, #1d2350 0%, transparent 35%),
          radial-gradient(circle at 90% 0%, #2f1f56 0%, transparent 40%), var(--bg);
      }

      .container {
        width: min(1120px, 92%);
        margin: 0 auto;
      }

      header {
        position: sticky;
        top: 0;
        z-index: 10;
        backdrop-filter: blur(12px);
        background: rgba(10, 13, 31, 0.72);
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }

      .nav {
        min-height: 72px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .brand {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        font-weight: 800;
        color: #fff;
        text-decoration: none;
      }

      .logo {
        width: 32px;
        height: 32px;
        border-radius: 10px;
        background: linear-gradient(135deg, var(--primary), #ff7ea8);
      }

      .links {
        display: flex;
        gap: 14px;
      }

      .btn {
        border: 1px solid rgba(255, 255, 255, 0.18);
        border-radius: 12px;
        padding: 10px 14px;
        color: #fff;
        text-decoration: none;
        background: rgba(255, 255, 255, 0.05);
      }

      main {
        padding: 32px 0 42px;
      }

      h1 {
        margin: 0 0 8px;
        font-size: clamp(1.8rem, 3vw, 2.5rem);
      }

      .lead {
        margin: 0;
        color: var(--muted);
      }

      .notice {
        margin-top: 16px;
        padding: 12px 14px;
        border-radius: 12px;
        background: rgba(124, 92, 255, 0.12);
        border: 1px solid rgba(124, 92, 255, 0.35);
        color: #d7cdff;
      }

      .grid {
        margin-top: 20px;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 14px;
      }

      .card {
        background: var(--card);
        border: 1px solid rgba(255, 255, 255, 0.14);
        border-radius: 16px;
        padding: 16px;
      }

      .meta {
        color: var(--muted);
        font-size: 0.92rem;
        margin-top: 8px;
      }

      .pill {
        display: inline-block;
        font-size: 0.8rem;
        margin-top: 8px;
        padding: 4px 8px;
        border-radius: 999px;
        background: rgba(45, 212, 191, 0.15);
        border: 1px solid rgba(45, 212, 191, 0.4);
        color: #b4fff2;
      }

      .empty {
        margin-top: 20px;
        padding: 18px;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px dashed rgba(255, 255, 255, 0.2);
        color: var(--muted);
      }

      @media (max-width: 980px) {
        .grid { grid-template-columns: 1fr 1fr; }
      }

      @media (max-width: 700px) {
        .grid { grid-template-columns: 1fr; }
        .links { gap: 8px; }
        .btn { padding: 8px 10px; font-size: 0.9rem; }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="container nav">
        <a class="brand" href="./index.html"><span class="logo"></span><span>Nimue</span></a>
        <div class="links">
          <a class="btn" href="./dm-publicar.html">Publicar partida</a>
          <a class="btn" href="./index.html">Landing</a>
        </div>
      </div>
    </header>

    <main class="container">
      <h1>Partidas publicadas</h1>
      <p class="lead">Explora las partidas creadas por DMs y consulta sus detalles.</p>
      <div id="notice" class="notice" style="display:none"></div>
      <div id="cards" class="grid"></div>
      <div id="empty" class="empty" style="display:none">Todavía no hay partidas publicadas.</div>
    </main>

    <script>
      const cardsEl = document.getElementById('cards');
      const emptyEl = document.getElementById('empty');
      const noticeEl = document.getElementById('notice');

      function formatDate(iso) {
        const d = new Date(iso);
        return Number.isNaN(d.getTime()) ? 'Fecha por confirmar' : d.toLocaleString();
      }

      function getLocalDrafts() {
        return JSON.parse(localStorage.getItem('nimue_drafts') || '[]').map((x) => ({
          id: x.id,
          title: x.title,
          description: x.description,
          mode: x.mode,
          dmName: x.dmName,
          onlineUrl: x.onlineUrl,
          locationText: x.locationText,
          sessions: [
            {
              startAt: x.startAt,
              durationMinutes: x.durationMinutes,
              slotsTotal: x.slotsTotal,
              pricePerPlayer: x.pricePerPlayer
            }
          ]
        }));
      }

      async function fetchCampaigns() {
        try {
          const res = await fetch('./api/campaigns', { headers: { Accept: 'application/json' } });
          if (!res.ok) throw new Error('backend_not_available');
          const ct = res.headers.get('content-type') || '';
          if (!ct.includes('application/json')) throw new Error('backend_not_available');
          const data = await res.json();
          if (!Array.isArray(data)) throw new Error('backend_not_available');
          return { source: 'api', campaigns: data };
        } catch {
          const local = getLocalDrafts();
          return { source: 'local', campaigns: local };
        }
      }

      function renderCampaign(campaign) {
        const s = campaign.sessions?.[0] || {};
        const card = document.createElement('article');
        card.className = 'card';
        card.innerHTML = `
          <h3 style="margin:0">${campaign.title || 'Partida sin título'}</h3>
          <div class="pill">${campaign.mode === 'presencial' ? 'Presencial' : 'Online'}</div>
          <p class="meta">${campaign.description || 'Sin descripción'}</p>
          <p class="meta"><strong>DM:</strong> ${campaign.dmName || 'No disponible'}</p>
          <p class="meta"><strong>Inicio:</strong> ${formatDate(s.startAt)}</p>
          <p class="meta"><strong>Duración:</strong> ${s.durationMinutes ?? '-'} min · <strong>Plazas:</strong> ${s.slotsTotal ?? '-'}</p>
          <p class="meta"><strong>Precio:</strong> ${s.pricePerPlayer ?? '-'}€ / jugador</p>
          <p class="meta"><strong>${campaign.mode === 'presencial' ? 'Ubicación' : 'Enlace'}:</strong> ${campaign.mode === 'presencial' ? (campaign.locationText || 'Por confirmar') : (campaign.onlineUrl || 'Por confirmar')}</p>
        `;
        cardsEl.appendChild(card);
      }

      async function init() {
        const { source, campaigns } = await fetchCampaigns();

        if (source === 'local') {
          noticeEl.style.display = 'block';
          noticeEl.textContent =
            'Mostrando partidas guardadas en este navegador (modo local/demo). Para catálogo global, conecta backend.';
        }

        if (!campaigns.length) {
          emptyEl.style.display = 'block';
          return;
        }

        campaigns.forEach(renderCampaign);
      }

      init();
    </script>
  </body>
</html>
