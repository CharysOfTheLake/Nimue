<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nimue | Partidas publicadas</title>
    <style>
      :root {
        --bg: #0a0d1f;
        --text: #f7f8ff;
        --muted: #b5bbdc;
        --primary: #7c5cff;
        --card: rgba(255, 255, 255, 0.08);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        color: var(--text);
        background: radial-gradient(circle at 20% 0%, #1d2350 0%, transparent 35%),
          radial-gradient(circle at 90% 0%, #2f1f56 0%, transparent 40%), var(--bg);
      }

      .container {
        width: min(1120px, 92%);
        margin: 0 auto;
      }

      header {
        position: sticky;
        top: 0;
        z-index: 10;
        backdrop-filter: blur(12px);
        background: rgba(10, 13, 31, 0.72);
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }

      .nav {
        min-height: 72px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .brand {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        font-weight: 800;
        color: #fff;
        text-decoration: none;
      }

      .logo {
        width: 32px;
        height: 32px;
        border-radius: 10px;
        background: linear-gradient(135deg, var(--primary), #ff7ea8);
      }

      .links {
        display: flex;
        gap: 14px;
      }

      .btn {
        border: 1px solid rgba(255, 255, 255, 0.18);
        border-radius: 12px;
        padding: 10px 14px;
        color: #fff;
        text-decoration: none;
        background: rgba(255, 255, 255, 0.05);
      }

      main {
        padding: 32px 0 42px;
      }

      h1 {
        margin: 0 0 8px;
        font-size: clamp(1.8rem, 3vw, 2.5rem);
      }

      .lead {
        margin: 0;
        color: var(--muted);
      }

      .notice,
      .flash {
        margin-top: 16px;
        padding: 12px 14px;
        border-radius: 12px;
      }

      .notice {
        background: rgba(124, 92, 255, 0.12);
        border: 1px solid rgba(124, 92, 255, 0.35);
        color: #d7cdff;
      }

      .flash {
        background: rgba(45, 212, 191, 0.12);
        border: 1px solid rgba(45, 212, 191, 0.35);
        color: #c9fff6;
      }

      .filters {
        margin-top: 14px;
        display: flex;
        justify-content: flex-end;
      }

      .filter-box {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 9px 12px;
        border: 1px solid rgba(255, 255, 255, 0.16);
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.05);
      }

      .filter-box label {
        color: var(--muted);
        font-size: 0.92rem;
      }

      .filter-box select {
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        padding: 7px 10px;
        background: rgba(9, 12, 30, 0.82);
        color: #fff;
      }

      .grid {
        margin-top: 20px;
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 14px;
      }

      .card {
        background: var(--card);
        border: 1px solid rgba(255, 255, 255, 0.14);
        border-radius: 16px;
        padding: 16px;
      }

      .card.new {
        border-color: rgba(45, 212, 191, 0.7);
        box-shadow: 0 0 0 2px rgba(45, 212, 191, 0.25), 0 10px 28px rgba(0, 0, 0, 0.3);
      }

      .meta {
        color: var(--muted);
        font-size: 0.92rem;
        margin-top: 8px;
      }

      .meta.break {
        overflow-wrap: anywhere;
      }

      .pill {
        display: inline-block;
        font-size: 0.8rem;
        margin-top: 8px;
        padding: 4px 8px;
        border-radius: 999px;
        background: rgba(45, 212, 191, 0.15);
        border: 1px solid rgba(45, 212, 191, 0.4);
        color: #b4fff2;
      }

      .actions {
        margin-top: 12px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .action-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        padding: 8px 12px;
        background: rgba(255, 255, 255, 0.06);
        color: #fff;
        text-decoration: none;
        font-size: 0.9rem;
        cursor: pointer;
      }

      .action-btn.primary {
        background: linear-gradient(135deg, var(--primary), #5f8cff);
        border-color: transparent;
      }

      .action-btn[aria-disabled='true'] {
        opacity: 0.55;
        pointer-events: none;
      }

      .empty {
        margin-top: 20px;
        padding: 18px;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px dashed rgba(255, 255, 255, 0.2);
        color: var(--muted);
      }

      @media (max-width: 820px) {
        .grid {
          grid-template-columns: 1fr;
        }
        .filters {
          justify-content: flex-start;
        }
      }

      @media (max-width: 700px) {
        .links {
          gap: 8px;
        }
        .btn {
          padding: 8px 10px;
          font-size: 0.9rem;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="container nav">
        <a class="brand" href="./index.html"><span class="logo"></span><span>Nimue</span></a>
        <div class="links">
          <a class="btn" href="./dm-publicar.html">Publicar partida</a>
          <a class="btn" href="./index.html">Landing</a>
        </div>
      </div>
    </header>

    <main class="container">
      <h1>Partidas publicadas</h1>
      <p class="lead">Explora las partidas creadas por DMs y consulta sus detalles.</p>
      <div id="notice" class="notice" style="display:none"></div>
      <div id="flash" class="flash" style="display:none"></div>

      <section class="filters" aria-label="Filtros de partidas">
        <div class="filter-box">
          <label for="sortBy">Ordenar por</label>
          <select id="sortBy">
            <option value="date_nearest">Fecha: más próxima primero</option>
            <option value="price_desc">Precio: más caras primero</option>
          </select>
        </div>
      </section>

      <div id="cards" class="grid"></div>
      <div id="empty" class="empty" style="display:none">Todavía no hay partidas publicadas.</div>
    </main>

    <script>
      const cardsEl = document.getElementById('cards');
      const emptyEl = document.getElementById('empty');
      const noticeEl = document.getElementById('notice');
      const flashEl = document.getElementById('flash');
      const sortByEl = document.getElementById('sortBy');

      let allCampaigns = [];
      let lastCreated = null;

      function formatDate(iso) {
        const d = new Date(iso);
        return Number.isNaN(d.getTime()) ? 'Fecha por confirmar' : d.toLocaleString();
      }

      function getTimestamp(campaign) {
        const startAt = campaign.sessions?.[0]?.startAt;
        const t = Date.parse(startAt || '');
        return Number.isNaN(t) ? Number.POSITIVE_INFINITY : t;
      }

      function getPrice(campaign) {
        const p = Number(campaign.sessions?.[0]?.pricePerPlayer);
        return Number.isFinite(p) ? p : Number.NEGATIVE_INFINITY;
      }

      function getLocalDrafts() {
        return JSON.parse(localStorage.getItem('nimue_drafts') || '[]').map((x) => ({
          id: x.id,
          title: x.title,
          description: x.description,
          mode: x.mode,
          dmName: x.dmName,
          onlineUrl: x.onlineUrl,
          locationText: x.locationText,
          sessions: [
            {
              startAt: x.startAt,
              durationMinutes: x.durationMinutes,
              slotsTotal: x.slotsTotal,
              pricePerPlayer: x.pricePerPlayer
            }
          ]
        }));
      }

      async function fetchCampaigns() {
        try {
          const res = await fetch('./api/campaigns', { headers: { Accept: 'application/json' } });
          if (!res.ok) throw new Error('backend_not_available');
          const ct = res.headers.get('content-type') || '';
          if (!ct.includes('application/json')) throw new Error('backend_not_available');
          const data = await res.json();
          if (!Array.isArray(data)) throw new Error('backend_not_available');
          return { source: 'api', campaigns: data };
        } catch {
          const local = getLocalDrafts();
          return { source: 'local', campaigns: local };
        }
      }

      function sortCampaigns(campaigns, sortBy) {
        const sorted = [...campaigns];

        if (sortBy === 'price_desc') {
          sorted.sort((a, b) => {
            const priceDiff = getPrice(b) - getPrice(a);
            if (priceDiff !== 0) return priceDiff;
            return getTimestamp(a) - getTimestamp(b);
          });
          return sorted;
        }

        sorted.sort((a, b) => getTimestamp(a) - getTimestamp(b));
        return sorted;
      }

      function renderCampaign(campaign, latestCreated) {
        const s = campaign.sessions?.[0] || {};
        const card = document.createElement('article');
        card.className = 'card';

        const cardId = String(campaign.id || '');
        if (latestCreated && cardId && cardId === String(latestCreated.id || '')) {
          card.classList.add('new');
        }

        const matchUrl =
          campaign.mode === 'presencial'
            ? campaign.locationText || ''
            : campaign.onlineUrl || '';

        const hasUrl = /^https?:\/\//.test(matchUrl);
        const linkButton = hasUrl
          ? `<a class="action-btn" href="${matchUrl}" target="_blank" rel="noopener noreferrer">Abrir enlace</a>`
          : '<span class="action-btn" aria-disabled="true">Sin enlace</span>';

        card.innerHTML = `
          <h3 style="margin:0">${campaign.title || 'Partida sin título'}</h3>
          <div class="pill">${campaign.mode === 'presencial' ? 'Presencial' : 'Online'}</div>
          <p class="meta">${campaign.description || 'Sin descripción'}</p>
          <p class="meta"><strong>DM:</strong> ${campaign.dmName || 'No disponible'}</p>
          <p class="meta"><strong>Inicio:</strong> ${formatDate(s.startAt)}</p>
          <p class="meta"><strong>Duración:</strong> ${s.durationMinutes ?? '-'} min · <strong>Plazas:</strong> ${s.slotsTotal ?? '-'}</p>
          <p class="meta"><strong>Precio:</strong> ${s.pricePerPlayer ?? '-'}€ / jugador</p>
          <p class="meta break"><strong>${campaign.mode === 'presencial' ? 'Ubicación' : 'Enlace'}:</strong> ${matchUrl || 'Por confirmar'}</p>
          <div class="actions">
            ${linkButton}
            <button class="action-btn primary" type="button" data-join="${cardId}">Unirse a ésta partida</button>
          </div>
        `;

        cardsEl.appendChild(card);
      }

      function renderList() {
        cardsEl.innerHTML = '';
        emptyEl.style.display = 'none';

        const sorted = sortCampaigns(allCampaigns, sortByEl.value);
        if (!sorted.length) {
          emptyEl.style.display = 'block';
          return;
        }

        sorted.forEach((campaign) => renderCampaign(campaign, lastCreated));
      }

      async function init() {
        try {
          lastCreated = JSON.parse(sessionStorage.getItem('nimue_last_created') || 'null');
        } catch {
          lastCreated = null;
        }

        const { source, campaigns } = await fetchCampaigns();
        allCampaigns = campaigns;

        if (source === 'local') {
          noticeEl.style.display = 'block';
          noticeEl.textContent =
            'Mostrando partidas guardadas en este navegador (modo local/demo). Para catálogo global, conecta backend.';
        }

        renderList();

        if (lastCreated?.id) {
          flashEl.style.display = 'block';
          flashEl.textContent = '✅ Tu partida se ha publicado y aparece en el listado.';
          sessionStorage.removeItem('nimue_last_created');
        }
      }

      sortByEl.addEventListener('change', renderList);

      cardsEl.addEventListener('click', (event) => {
        const joinButton = event.target.closest('[data-join]');
        if (!joinButton) return;

        const id = joinButton.getAttribute('data-join');
        const campaign = allCampaigns.find((c) => String(c.id || '') === String(id));
        const title = campaign?.title || 'esta partida';
        alert(`Te quieres unir a: ${title}. En el próximo paso conectaremos este botón con el flujo de reserva.`);
      });

      init();
    </script>
  </body>
</html>
